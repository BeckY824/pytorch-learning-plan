# 什么是 Top-K 和 Top-P 采样？Temperature 如何影响生成结果？

`model.generate()` 中常见的三个参数：top-k, top-p 和 temperature

生成文本时，模型为每个可能的下一个词汇分配一个概率分布，选择下一个词汇的策略直接决定的输出的质量和多样性。以下是常见的选择方法：

- Greedy search
- Beam search
- top-k 采样：限制候选词汇数量
- top-p 采样：根据累积概率选择候选词汇，动态调整词汇集

| 词汇  | 概率 |
| ----- | ---- |
| A     | 0.4  |
| B     | 0.3  |
| C     | 0.2  |
| D     | 0.05 |
| <eos> | 0.05 |

## Top-K 采样

### **工作原理**

通过限制候选词汇数量来增加生成文本多样性的方法。在每一步生成的过程中，模型只考虑概率最高的 K 个词汇，然后从这 K 个词汇中根据概率进行采样。

**步骤：**

1. 获取概率分布：模型为每个可能的下一个词汇生成一个概率分布。
2. 筛选 Top-K：选择概率最高的 K 个词汇，忽略其余词汇。
3. 重新归一化：将筛选后的词汇的概率重新归一化，使其总和为1
4. 采样：根据重新归一化后的概率分布，从 Top-K 词汇中随机采样一个词汇作为下一个生成的词。

## Top-P 采样

### 工作原理

与 Top-K 不同，Top-P 采样不是固定选择 K 个词汇，而是选择一组累计概率达到 P 的词汇集合（即从高到低加起来的概率）。可以根据当前的概率分布动态调整候选词汇的数量，从而更好的平衡生成的多样性和质量。

**步骤：**

1. 获取概率分布
2. 排序概率
3. 累计概率
4. 筛选 Top - P
5. 重新归一化
6. 采样

## Temperature的作用

控制生成文本随机性的参数。

### 工作原理

在进行采样前，模型实际上会对概率分布应用温度调整：
$$
P'(y|Y) = \frac{P(y|Y)^{1/\text{temperature}}}{\sum_{y'} P(y'|Y)^{1/\text{temperature}}}
$$
**Temperature**通过改变概率分布的 “锐度” 来控制生成的随机性。具体来说：

- 当温度趋近于 0， 结果会趋近于一个 one-hot 分布，即总是选择概率最高的词汇。
- 当温度趋近于1，结果保持原始分布。
- 当温度大于1，结果分布更加均匀，相对增加原本低概率词汇的选择概率。

<img src="/Users/edward_beck8n24/Library/Application Support/typora-user-images/image-20250723140320521.png" alt="image-20250723140320521" style="zoom:50%;" />

- 温度小于1时，概率分布变得更加尖锐，高概率词更困难被选择，适用于需要高确定性的任务，如生成文档或代码
- 温度大于1时，概率分布更加平坦，适用于需要创造性和多样性的任务，如写作或对话生成

## 在大模型中的应用

**Top-K 和 Top-P 是否可以一起使用？**

可以，模型首先会应用 Top-K 筛选，限制候选词汇数量，然后在有限的词汇中应用 Top-P 采样，动态调整词汇集合。

**如果只想使用其一呢？**

`top_p = 1` 表示不使用 top-p

`top_k = 0` 表示不使用top-k

